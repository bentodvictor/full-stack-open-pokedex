# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Deployment pipeline

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master"]
    types: ["opened", "synchronize"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run eslint
      - name: Build
        run: npm run build
      - name: Test
        run: npm run test
      - name: E2E Test
        run: |
          npx playwright install --with-deps
          npx playwright test
      - name: Deploy
        # Only run this step if the branch is main
        if: ${{ (github.ref == 'refs/heads/master') && (github.event_name == 'push')}}
        env:
          deploy_url: https://api.render.com/deploy/srv-${{ secrets.RENDER_SERVICE_ID }}?key=${{ secrets.RENDER_API_KEY }}
        run: |
          curl "$deploy_url"
  tag_release:
    needs: [deploy]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Print commit messages
        env:
          COMMIT_MESSAGES: ${{ toJson(github.event.commits.*.messages) }}
        run: echo "$COMMIT_MESSAGES"

      - name: Check for '#skip' in commit messages
        id: check_skip
        run: |
          echo "Checking for #skip in commit messages..."
          echo '${{ toJson(github.event.commits.*.message) }}' > messages.json
          if grep -q "#skip" messages.json; then
            echo "Found #skip. Skipping tag and deploy."
            echo "skip_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "No #skip found."
            echo "skip_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Tag commit
        if: ${{ (github.ref == 'refs/heads/master') && (github.event_name == 'push') && steps.check_skip.outputs.skip_deploy == 'false' }}
        uses: anothrNick/github-tag-action@1.75.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
